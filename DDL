‚úÖ C√°ch t·ªët nh·∫•t: Auto-recreate capture instance + Auto-trigger incremental snapshot

Debezium 2.0+ h·ªó tr·ª£ incremental snapshot, v√† SQL Server CDC ho√†n to√†n cho ph√©p b·∫°n enable/disable table CDC b·∫±ng procedure.

B·∫°n s·∫Ω t·ª± ƒë·ªông h√≥a to√†n b·ªô v√≤ng:

Detect schema change ‚Üí recreate capture instance ‚Üí trigger incremental snapshot

üìå Ki·∫øn tr√∫c t·ªïng th·ªÉ

S·ª≠ d·ª•ng DDL trigger ‚Üí ph√°t hi·ªán ALTER TABLE ADD COLUMN

Trigger ghi s·ª± ki·ªán v√†o m·ªôt b·∫£ng ALETS (log table)

M·ªôt SQL Agent Job ch·∫°y m·ªói X gi√¢y:

Ki·ªÉm tra log

Disable capture instance c≈©

Enable capture instance m·ªõi

Insert signal v√†o signaling table c·ªßa Debezium ƒë·ªÉ trigger incremental snapshot

K·∫øt qu·∫£: Kafka nh·∫≠n ƒë·ªß schema + ƒë·ªß d·ªØ li·ªáu, kh√¥ng m·∫•t record.

üß© 1. T·∫°o Trigger DDL ph√°t hi·ªán thay ƒë·ªïi schema
CREATE TRIGGER trg_detect_table_changes
ON DATABASE
FOR ALTER_TABLE
AS
BEGIN
    INSERT INTO dbo.schema_change_log(table_name, change_time)
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/ObjectName)[1]', 'sysname'),
           GETDATE();
END


B·∫£ng log:

CREATE TABLE dbo.schema_change_log(
    id INT IDENTITY PRIMARY KEY,
    table_name sysname,
    change_time DATETIME DEFAULT GETDATE(),
    processed BIT DEFAULT 0
);

üß© 2. Job t·ª± ƒë·ªông recreate capture instance

N·ªôi dung job (T-SQL):

DECLARE @table sysname;

SELECT TOP 1 @table = table_name
FROM dbo.schema_change_log
WHERE processed = 0;

IF @table IS NOT NULL
BEGIN
    DECLARE @schema sysname = 'dbo';

    -- Disable CDC for table
    EXEC sys.sp_cdc_disable_table 
        @source_schema = @schema,
        @source_name   = @table;

    -- Re-enable CDC for table (capture instance m·ªõi)
    EXEC sys.sp_cdc_enable_table 
        @source_schema = @schema,
        @source_name   = @table,
        @role_name     = NULL,
        @supports_net_changes = 0;

    -- Mark processed
    UPDATE dbo.schema_change_log
    SET processed = 1
    WHERE table_name = @table;
END


B·∫°n c√≥ th·ªÉ ch·∫°y job m·ªói 10 gi√¢y / 1 ph√∫t t√πy nhu c·∫ßu.

üß© 3. G·ª≠i signal cho Debezium ƒë·ªÉ ch·∫°y l·∫°i incremental snapshot

Debezium c·∫ßn signaling table:

CREATE TABLE dbo.debezium_signal (
  id VARCHAR(64),
  type VARCHAR(32),
  data VARCHAR(max)
);


Trong job SQL Agent, th√™m ƒëo·∫°n sau sau khi recreate capture instance:

INSERT INTO dbo.debezium_signal (id, type, data)
VALUES (
   CONCAT(@table, '_snap_', CONVERT(VARCHAR, GETDATE(), 112)),
   'execute-snapshot',
   '{"data-collections": ["dbo.' + @table + '"] }'
);


Debezium 2.4 s·∫Ω t·ª± ƒë·ªông:

Detect schema m·ªõi

Snapshot l·∫°i to√†n b·ªô b·∫£ng (incremental snapshot)

Li√™n k·∫øt CDC m·ªõi

ƒê·∫©y ƒë·∫ßy ƒë·ªß record (k·ªÉ c·∫£ update tr∆∞·ªõc khi recreate capture instance)
